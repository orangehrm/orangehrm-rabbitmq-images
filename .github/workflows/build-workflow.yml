name: Image Build Workflow

on:
    push:
      branches: [ rabbitmq-3.9.8-centos-7 ]   
    pull_request:
      branches: [ rabbitmq-3.9.8-centos-7 ]

env:
    DOCKER_HUB_REPO: "orangehrm/orangehrm-rabbitmq"
    DEFAULT_TAG_NAME: "rabbitmq-3.9.8-centos-7"
    UPSTREAM_REPO: "orangehrm/orangehrm-rabbitmq-images"
    UPSTREAM_BRANCH: "refs/heads/rabbitmq-3.9.8-centos-7"

jobs:
    Build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v2
            
            - name: Verify prerequisits
              run: |
                docker --version
                docker-compose --version
                composer --version
            
            - name: Install test suite dependencis
              run: composer install
                          
            - name: Build docker image
              run: docker build -t ${{ env.DOCKER_HUB_REPO }}:${{ env.DEFAULT_TAG_NAME }} docker-image

            - name: Spin up a container
              run: | 
                docker-compose up -d
                docker ps -a

            - name: Run unit test suite
              run: |
                sleep 10s
                php vendor/bin/codecept run unit
                
            - name: Get installed rabbitmq version
              run: echo "VERSION_TAG_NAME=rabbitmq-$(docker exec rabbitmq_container rabbitmqctl --version)-centos-7" >> $GITHUB_ENV

            - name: New image with a version tag
              run: docker tag ${{ env.DOCKER_HUB_REPO }}:${{ env.DEFAULT_TAG_NAME }} ${{ env.DOCKER_HUB_REPO }}:${{ env.VERSION_TAG_NAME }} 

            - name: Docker hub login
              if: ${{ github.repository == env.UPSTREAM_REPO && github.ref == env.UPSTREAM_BRANCH }}
              run: docker login -u=${{ secrets.DOCKER_HUB_USERNAME }} -p=${{ secrets.DOCKER_HUB_PASSWORD }}            

            - name: Check installed Rabbitmq version
              if: ${{ env.DEFAULT_TAG_NAME }} != ${{ env.VERSION_TAG_NAME }}
              run: echo 'ERROR - New RabbitMQ version is identified. Please create a new branch'

            - name: Deploy changes to the docker hub
              if: ${{ github.repository == env.UPSTREAM_REPO && github.ref == env.UPSTREAM_BRANCH && env.DEFAULT_TAG_NAME == env.VERSION_TAG_NAME }}
              run: |
                docker push ${{ env.DOCKER_HUB_REPO }}:${{ env.VERSION_TAG_NAME }}
                echo 'SUCCESS - IMAGE WAS PUBLISHED ${{ env.DOCKER_HUB_REPO }}:${{ env.VERSION_TAG_NAME }}'
 
            - name: Docker hub logout
              if: ${{ github.repository == env.UPSTREAM_REPO && github.ref == env.UPSTREAM_BRANCH }}
              run: docker logout